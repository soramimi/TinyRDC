# Rapsodia 仕様書

## 概要

Rapsodiaは、Qt6とFreeRDPライブラリを使用したシンプルで軽量なリモートデスクトップクライアントアプリケーションです。WindowsマシンへのRDP接続を提供し、基本的なリモートデスクトップ操作を可能にします。

## 基本情報

- **プロジェクト名**: Rapsodia
- **開発者**: soramimi.jp
- **プログラミング言語**: C++17
- **GUIフレームワーク**: Qt 6.9.0
- **RDPライブラリ**: FreeRDP 3.x
- **ビルドシステム**: qmake
- **対象OS**: Linux

## 依存関係

### 必須ライブラリ
- Qt 6.9.0以上 (core, gui, widgets)
- FreeRDP 3.x
  - libfreerdp3
  - libfreerdp-client3
  - libwinpr3

### インクルードパス
- `/usr/include/freerdp3`
- `/usr/include/winpr3`

## アーキテクチャ

### クラス構成

#### MainWindow
**役割**: メインウィンドウとRDP接続の中心的な管理
- RDP接続・切断の制御
- FreeRDPコールバック関数の実装
- 別スレッドでのRDPイベント処理
- 画面更新タイマーの管理
- フルスクリーン切り替え機能
- ウィンドウ状態の永続化

#### MyView
**役割**: リモートデスクトップ画面の表示と入力処理
- QImageによる画面描画
- マウス入力（クリック、移動、ホイール）のRDP転送
- キーボード入力のRDP転送
- 画面スケーリング（1倍/2倍）
- 座標変換（Qt座標系 ↔ RDP座標系）

#### ConnectionDialog
**役割**: RDP接続情報の入力UI
- ホスト名/IPアドレス入力
- ユーザー名入力
- パスワード入力（マスク表示）
- ドメイン入力

#### MySettings
**役割**: アプリケーション設定の管理
- QSettingsベースの設定永続化
- INIファイル形式での設定保存
- ウィンドウジオメトリの保存・復元

#### ApplicationGlobal
**役割**: アプリケーション全体の基本情報管理
- 組織名、アプリケーション名の定義
- 設定ファイルパスの管理
- 実行ファイルパスの取得

### ユーティリティ

#### joinpath
**機能**: クロスプラットフォーム対応のパス結合
- 文字列とQStringの両方に対応
- クォート除去機能
- 区切り文字の正規化

## 機能仕様

### RDP接続機能
- **対応プロトコル**: RDP (Remote Desktop Protocol)
- **解像度**: 1920x1080固定
- **色深度**: 32bit
- **認証**: ユーザー名/パスワード認証
- **ドメイン**: Windowsドメイン対応

### 画面表示機能
- **フォーマット**: RGB24
- **スケーリング**: 1倍、2倍切り替え可能
- **更新頻度**: 16ms間隔（約60FPS）
- **描画最適化**: QImageによる高速描画

### 入力機能

#### マウス操作
- **左クリック**: PTR_FLAGS_BUTTON1
- **右クリック**: PTR_FLAGS_BUTTON2  
- **中クリック**: PTR_FLAGS_BUTTON3
- **マウス移動**: リアルタイム座標転送
- **ホイール**: 垂直・水平スクロール対応

#### キーボード操作
- **キー入力**: スキャンコード変換による正確な入力
- **修飾キー**: Ctrl、Shift、Alt対応
- **リピート**: オートリピート対応

### UI機能

#### メインウィンドウ
- **メニューバー**: ファイルメニュー（接続・切断）
- **ステータスバー**: 接続状態表示
- **フルスクリーン**: Ctrl+Shift+Alt+F で切り替え
- **スケール切り替え**: Ctrl+Shift+Alt+D で1倍/2倍切り替え

#### 接続ダイアログ
- **デフォルト値**: 
  - ホスト: 192.168.0.20
  - ドメイン: WORKGROUP
- **入力検証**: 必要な項目の入力チェック
- **パスワード**: セキュアな入力（マスク表示）

### パフォーマンス最適化
- **FastPath**: 入出力の高速化
- **ビットマップキャッシュ**: 有効
- **圧縮**: RDP8レベル
- **オフスクリーンサポート**: レベル1
- **グリフサポート**: レベル1
- **サーフェスコマンド**: 有効
- **ネットワーク自動検出**: 有効

## ファイル構成

### ソースファイル
```
main.cpp              - エントリーポイント
MainWindow.cpp/h      - メインウィンドウ実装
MyView.cpp/h          - 画面表示・入力処理
ConnectionDialog.cpp/h - 接続ダイアログ
MySettings.cpp/h      - 設定管理
Global.cpp/h          - グローバル定義
joinpath.cpp/h        - パスユーティリティ
```

### UIファイル
```
MainWindow.ui         - メインウィンドウレイアウト
ConnectionDialog.ui   - 接続ダイアログレイアウト
```

### 設定ファイル
```
Rapsodia.pro          - qmakeプロジェクトファイル
```

## ビルド仕様

### ビルド設定
- **コンパイラ**: C++17対応
- **Qt設定**: core gui widgets
- **出力**: Rapsodia実行ファイル

### ビルドコマンド
```bash
qmake Rapsodia.pro
make
```

### ビルド成果物
- **Debug**: build/Qt_6_9_0-Debug/Rapsodia
- **Release**: build/Qt_6_9_0-Release/Rapsodia

## 設定仕様

### 設定ファイルパス
```
~/.config/soramimi.jp/TonyRDC/TonyRDC.ini
```

### 保存される設定項目
- ウィンドウジオメトリ
- 最大化状態
- 接続履歴（予定）

## 操作仕様

### キーボードショートカット
- **Ctrl+N**: 新規接続
- **Ctrl+Shift+Alt+F**: フルスクリーン切り替え
- **Ctrl+Shift+Alt+D**: 表示スケール切り替え

### メニュー操作
- **File → Connect**: 接続ダイアログを開く
- **File → Disconnect**: 現在の接続を切断

### マウス操作
- **左クリック**: リモートマシンでの左クリック
- **右クリック**: リモートマシンでの右クリック
- **中クリック**: リモートマシンでの中クリック
- **ホイール**: リモートマシンでのスクロール

## エラーハンドリング

### 接続エラー
- 接続失敗時はエラーダイアログを表示
- FreeRDPインスタンス作成失敗の検出
- ネットワークエラーの適切な処理

### アプリケーション終了
- 接続中の終了時は確認ダイアログを表示
- フルスクリーン中は終了を無効化
- 設定の自動保存

## 制限事項

### 現在の制限
- 解像度は1920x1080固定
- 音声転送は未サポート
- ファイル転送は未サポート
- クリップボード共有は未サポート
- プリンタリダイレクトは未サポート

### 技術的制限
- FreeRDP 3.xに依存
- Linux環境のみサポート
- X11/Waylandディスプレイサーバーが必要

## 今後の拡張予定

### 機能拡張
- 可変解像度対応
- 接続履歴の保存・管理
- 音声リダイレクト
- クリップボード共有
- ファイル転送機能

### UI改善
- 接続プロファイル管理
- より詳細な設定UI
- 接続品質インジケータ
- ログ表示機能

## バージョン情報

- **現在のバージョン**: 1.0.0（開発中）
- **Qt要求バージョン**: 6.9.0以上
- **FreeRDP要求バージョン**: 3.x
- **最終更新**: 2025年6月2日
